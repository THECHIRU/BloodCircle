"""
Authentication routes for user registration, login, and password management.
"""
from flask import render_template, redirect, url_for, flash, request, session
from flask_login import login_user, logout_user, current_user, login_required
from datetime import datetime
from app import db
from app.auth import auth_bp
from app.models import User, OTP
from app.forms import (
    RegistrationForm, LoginForm, OTPVerificationForm,
    ForgotPasswordForm, ResetPasswordForm
)
from app.utils import create_and_send_otp, verify_otp


@auth_bp.route('/register', methods=['GET', 'POST'])
def register():
    """User registration with email and phone."""
    if current_user.is_authenticated:
        return redirect(url_for('main.index'))
    
    form = RegistrationForm()
    
    if form.validate_on_submit():
        # Create new user
        user = User(
            email=form.email.data.lower(),
            phone=form.phone.data,
            role='donor',  # Default role, will be updated during profile creation
            is_verified=False,
            is_active=True
        )
        user.set_password(form.password.data)
        
        db.session.add(user)
        db.session.commit()
        
        # Store user ID in session for OTP verification
        session['pending_user_id'] = user.id
        session['pending_email'] = user.email
        session['pending_phone'] = user.phone
        
        # Send OTP
        success, message = create_and_send_otp(
            user_id=user.id,
            email=user.email,
            phone=user.phone,
            otp_type='email',
            user_name='User'
        )
        
        if success:
            flash('Registration successful! Please verify your account with the OTP sent to your email/phone.', 'success')
            return redirect(url_for('auth.verify_otp_route'))
        else:
            flash(f'Registration successful, but failed to send OTP: {message}', 'warning')
            return redirect(url_for('auth.verify_otp_route'))
    
    return render_template('auth/register.html', form=form, title='Register')


@auth_bp.route('/verify-otp', methods=['GET', 'POST'])
def verify_otp_route():
    """Verify OTP after registration."""
    if current_user.is_authenticated:
        return redirect(url_for('main.index'))
    
    # Check if user has a pending verification
    user_id = session.get('pending_user_id')
    email = session.get('pending_email')
    
    if not user_id or not email:
        flash('No pending verification found. Please register first.', 'warning')
        return redirect(url_for('auth.register'))
    
    form = OTPVerificationForm()
    
    if form.validate_on_submit():
        # Verify OTP
        success, message, otp_record = verify_otp(
            otp_code=form.otp.data,
            user_id=user_id,
            email=email,
            otp_type='email'
        )
        
        if success:
            # Mark user as verified
            user = User.query.get(user_id)
            if user:
                user.is_verified = True
                db.session.commit()
                
                # Clear session
                session.pop('pending_user_id', None)
                session.pop('pending_email', None)
                session.pop('pending_phone', None)
                
                flash('Account verified successfully! Please complete your profile.', 'success')
                
                # Redirect to role selection or profile creation
                return redirect(url_for('auth.select_role'))
        else:
            flash(message, 'danger')
    
    return render_template('auth/verify_otp.html', form=form, email=email, title='Verify OTP')


@auth_bp.route('/select-role')
def select_role():
    """Allow user to select their role (donor or patient)."""
    if current_user.is_authenticated:
        return redirect(url_for('main.index'))
    
    # This would typically check session for verified but not logged in user
    # For simplicity, we'll show the role selection page
    return render_template('auth/select_role.html', title='Select Role')


@auth_bp.route('/resend-otp', methods=['POST'])
def resend_otp():
    """Resend OTP to user."""
    user_id = session.get('pending_user_id')
    email = session.get('pending_email')
    phone = session.get('pending_phone')
    
    if not user_id or not email:
        flash('No pending verification found.', 'warning')
        return redirect(url_for('auth.register'))
    
    success, message = create_and_send_otp(
        user_id=user_id,
        email=email,
        phone=phone,
        otp_type='email',
        user_name='User'
    )
    
    if success:
        flash('OTP resent successfully!', 'success')
    else:
        flash(f'Failed to resend OTP: {message}', 'danger')
    
    return redirect(url_for('auth.verify_otp_route'))


@auth_bp.route('/login', methods=['GET', 'POST'])
def login():
    """User login."""
    if current_user.is_authenticated:
        # Redirect based on role
        if current_user.role == 'admin':
            return redirect(url_for('admin.dashboard'))
        elif current_user.role == 'sub_admin':
            return redirect(url_for('admin.sub_admin_dashboard'))
        elif current_user.role == 'donor':
            return redirect(url_for('donor.dashboard'))
        elif current_user.role == 'patient':
            return redirect(url_for('patient.dashboard'))
        return redirect(url_for('main.index'))
    
    form = LoginForm()
    
    if form.validate_on_submit():
        user = User.query.filter_by(email=form.email.data.lower()).first()
        
        if user and user.check_password(form.password.data):
            # Check if user is blocked
            if user.is_blocked:
                flash('Your account has been blocked by an administrator. Please contact support.', 'danger')
                return redirect(url_for('auth.login'))
            
            # Check if account is deleted
            if user.deleted_at:
                days_since_deletion = (datetime.utcnow() - user.deleted_at).days
                if days_since_deletion <= 30:
                    flash(f'Your account was deleted {days_since_deletion} days ago. Click "Recover Account" to restore it.', 'warning')
                    return render_template('auth/login.html', form=form, title='Login', 
                                         show_recovery=True, recovery_email=user.email)
                else:
                    flash('Your account was permanently deleted after 30 days.', 'danger')
                    return redirect(url_for('auth.login'))
            
            if not user.is_active:
                flash('Your account has been deactivated. Please contact support.', 'danger')
                return redirect(url_for('auth.login'))
            
            if not user.is_verified:
                flash('Please verify your account first.', 'warning')
                session['pending_user_id'] = user.id
                session['pending_email'] = user.email
                session['pending_phone'] = user.phone
                return redirect(url_for('auth.verify_otp_route'))
            
            # Check if user has completed profile
            if user.role == 'donor' and not user.donor:
                flash('Please complete your donor profile.', 'info')
                login_user(user, remember=form.remember_me.data)
                user.last_login = datetime.utcnow()
                db.session.commit()
                return redirect(url_for('donor.register'))
            
            if user.role == 'patient' and not user.patient:
                flash('Please complete your patient profile.', 'info')
                login_user(user, remember=form.remember_me.data)
                user.last_login = datetime.utcnow()
                db.session.commit()
                return redirect(url_for('patient.register'))
            
            # Login successful
            login_user(user, remember=form.remember_me.data)
            user.last_login = datetime.utcnow()
            db.session.commit()
            
            flash(f'Welcome back, {user.email}!', 'success')
            
            # Redirect to next page or dashboard
            next_page = request.args.get('next')
            if next_page:
                return redirect(next_page)
            
            if user.role == 'admin':
                return redirect(url_for('admin.dashboard'))
            elif user.role == 'donor':
                return redirect(url_for('donor.dashboard'))
            elif user.role == 'patient':
                return redirect(url_for('patient.dashboard'))
            
            return redirect(url_for('main.index'))
        else:
            flash('Invalid email or password.', 'danger')
    
    return render_template('auth/login.html', form=form, title='Login')


@auth_bp.route('/logout')
def logout():
    """User logout."""
    logout_user()
    flash('You have been logged out successfully.', 'info')
    return redirect(url_for('main.index'))


@auth_bp.route('/forgot-password', methods=['GET', 'POST'])
def forgot_password():
    """Forgot password - request OTP."""
    if current_user.is_authenticated:
        return redirect(url_for('main.index'))
    
    form = ForgotPasswordForm()
    
    if form.validate_on_submit():
        user = User.query.filter_by(email=form.email.data.lower()).first()
        
        if user:
            # Store email in session
            session['reset_email'] = user.email
            
            # Send OTP
            success, message = create_and_send_otp(
                user_id=user.id,
                email=user.email,
                otp_type='password_reset',
                user_name=user.donor.full_name if user.donor else (
                    user.patient.full_name if user.patient else 'User'
                )
            )
            
            if success:
                flash('Password reset OTP sent to your email.', 'success')
                return redirect(url_for('auth.reset_password'))
            else:
                flash(f'Failed to send OTP: {message}', 'danger')
        else:
            # Don't reveal if email exists or not (security)
            flash('If an account exists with this email, you will receive a password reset OTP.', 'info')
            return redirect(url_for('auth.login'))
    
    return render_template('auth/forgot_password.html', form=form, title='Forgot Password')


@auth_bp.route('/reset-password', methods=['GET', 'POST'])
def reset_password():
    """Reset password with OTP."""
    if current_user.is_authenticated:
        return redirect(url_for('main.index'))
    
    email = session.get('reset_email')
    
    if not email:
        flash('Please request a password reset first.', 'warning')
        return redirect(url_for('auth.forgot_password'))
    
    form = ResetPasswordForm()
    
    if form.validate_on_submit():
        # Verify OTP
        user = User.query.filter_by(email=email).first()
        
        if not user:
            flash('Invalid session. Please try again.', 'danger')
            return redirect(url_for('auth.forgot_password'))
        
        success, message, otp_record = verify_otp(
            otp_code=form.otp.data,
            user_id=user.id,
            email=email,
            otp_type='password_reset'
        )
        
        if success:
            # Reset password
            user.set_password(form.password.data)
            db.session.commit()
            
            # Clear session
            session.pop('reset_email', None)
            
            flash('Password reset successfully! Please login with your new password.', 'success')
            return redirect(url_for('auth.login'))
        else:
            flash(message, 'danger')
    
    return render_template('auth/reset_password.html', form=form, email=email, title='Reset Password')


@auth_bp.route('/delete-account', methods=['POST'])
@login_required
def delete_account():
    """Soft delete user account - can be recovered within 30 days."""
    user = current_user
    
    # Set deletion timestamp
    user.deleted_at = datetime.utcnow()
    user.is_active = False
    
    # Update donor/patient availability
    if user.role == 'donor' and user.donor:
        user.donor.is_available = False
    
    db.session.commit()
    
    # Logout user
    logout_user()
    
    flash('Your account has been deleted. You can recover it within 30 days by logging in.', 'info')
    return redirect(url_for('main.index'))


@auth_bp.route('/recover-account', methods=['POST'])
def recover_account():
    """Recover a deleted account within 30 days."""
    email = request.form.get('email')
    password = request.form.get('password')
    
    if not email or not password:
        flash('Please provide email and password.', 'danger')
        return redirect(url_for('auth.login'))
    
    user = User.query.filter_by(email=email).first()
    
    if not user or not user.check_password(password):
        flash('Invalid email or password.', 'danger')
        return redirect(url_for('auth.login'))
    
    if not user.deleted_at:
        flash('This account is not deleted.', 'info')
        return redirect(url_for('auth.login'))
    
    # Check if within 30-day recovery period
    days_since_deletion = (datetime.utcnow() - user.deleted_at).days
    
    if days_since_deletion > 30:
        flash('Recovery period has expired. This account cannot be recovered.', 'danger')
        return redirect(url_for('auth.login'))
    
    # Recover account
    user.deleted_at = None
    user.is_active = True
    db.session.commit()
    
    flash('Your account has been successfully recovered! Please log in.', 'success')
    return redirect(url_for('auth.login'))
